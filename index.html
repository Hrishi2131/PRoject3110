<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>Happy Birthday My Leady üíô</title>
	<script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js" type="module"></script>
	<script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js" type="module"></script>
	<script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js" type="module"></script>
	<style>
		@import url('https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&family=Poppins:wght@400;600&display=swap');

		:root {
			/* Background Colors */
			--bg-grad-1: #1e3c72;
			--bg-grad-2: #2a5298;
			
			/* NEW GIFT BOX COLORS (from image) */
			--gift-box-color: #53d8e5; /* Bright Tiffany Blue */
			--gift-box-color-dark: #3cc6d4; /* Shadow for box */
			--gift-lid-color: #f7b7cf; /* Light Pastel Pink */
			--gift-lid-color-dark: #e0a3be; /* Shadow for lid */
			
			--gift-ribbon-color: #ffffff;
			--text-color: #ffffff;
			--accent-color: #89f7fe; /* Sky Blue */
			--dark-blue: #00264d;
			--hug-color: #ffb6c1; /* Light Pink for 'hug' effect */
			
			/* Shadows */
			--box-shadow-color: rgba(0, 0, 0, 0.2);
			--inset-shadow-color: rgba(255, 255, 255, 0.4);
		}

		body {
			margin: 0;
			height: 100vh;
			font-family: 'Poppins', sans-serif;
			color: var(--text-color);
			overflow: hidden;
			display: flex;
			flex-direction: column;
			align-items: center;
			justify-content: center;
			background: linear-gradient(135deg, var(--bg-grad-1), var(--bg-grad-2), #1e3c72);
			background-size: 200% 200%;
			animation: gradientShift 15s ease infinite;
		}

		@keyframes gradientShift {
			0% { background-position: 0% 50%; }
			50% { background-position: 100% 50%; }
			100% { background-position: 0% 50%; }
		}

		/* --- Shared Screen Styles --- */
		#intro, .message-screen {
			position: fixed;
			top: 0; left: 0;
			width: 100%; height: 100%;
			display: none; /* Default state */
			align-items: center;
			justify-content: center;
			flex-direction: column;
			z-index: 100;
			color: white;
			text-align: center;
			padding: 30px;
		}
		
		#intro {
			background: linear-gradient(135deg, #1e3c72, #2a5298);
			z-index: 100;
			transition: opacity 2s ease, visibility 2s;
			display: flex;
		}

		.message-screen {
			background: rgba(10, 20, 60, 0.95);
			animation: fadeIn 1s ease;
		}

		#intro h1 {
			font-size: 2.5em;
			text-align: center;
			padding: 0 20px;
			border-right: 3px solid var(--accent-color);
			white-space: nowrap;
			overflow: hidden;
			animation: typing 2.5s steps(30) 1 normal both,
						blinkCursor 0.75s steps(30) infinite normal;
			font-family: 'Dancing Script', cursive;
		}
		
		#intro-prompt {
			margin-top: 25px;
			font-size: 1.3em;
			opacity: 0;
			animation: fadeIn 1s ease forwards 3s;
			cursor: pointer;
			text-shadow: 0 0 10px var(--accent-color);
		}

		@keyframes typing { from { width: 0; } to { width: 100%; } }
		@keyframes blinkCursor {
			from { border-right-color: var(--accent-color); }
			to { border-right-color: transparent; }
		}
		@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
		@keyframes fadeOut { to { opacity: 0; visibility: hidden; } }
		
		.message-screen h2 {
			font-size: 3em;
			margin-bottom: 15px;
			font-family: 'Dancing Script', cursive;
			color: var(--hug-color);
		}
		
		/* --- ADJUSTMENTS FOR LARGER MESSAGE WINDOW --- */
		.message-text {
			font-size: 1.25em;
			/* INCREASED MAX-WIDTH to utilize more horizontal page space */
			max-width: 1200px; 
			width: 90%; /* Fluid width for responsiveness on smaller screens */
			line-height: 1.6em;
			white-space: pre-wrap;
			min-height: 100px;
			font-family: 'Poppins', sans-serif;
			
			/* Crucial for vertical scrolling and responsive height */
			max-height: 70vh; /* Limits height to 70% of viewport */
			overflow-y: auto; /* Adds scrollbar if content exceeds max-height */
			padding: 15px;
			margin-bottom: 20px;
			border-radius: 10px;
			background: rgba(0, 0, 0, 0.1);
		}
		
		.message-text.breathing-text {
			animation: textBreathe 2.5s ease-in-out infinite;
		}
		
		@keyframes textBreathe {
			0%, 100% { text-shadow: 0 0 5px rgba(255, 255, 255, 0.4); }
			50% { text-shadow: 0 0 12px var(--accent-color); }
		}

		button.next-btn {
			margin-top: 20px; /* Reduced margin to save vertical space */
			background: var(--hug-color);
			border: none;
			color: var(--dark-blue);
			padding: 12px 25px;
			border-radius: 30px;
			font-size: 1em;
			font-weight: bold;
			cursor: pointer;
			box-shadow: 0 0 15px rgba(255,255,255,0.3);
			transition: all 0.3s;
		}

		button.next-btn:hover {
			transform: scale(1.05);
			box-shadow: 0 0 25px rgba(255,255,255,0.5);
		}
		
		/* --- Music Player Styles --- */
		.player-container {
			margin-top: 30px;
			display: flex;
			gap: 15px;
		}

		.player-container button {
			background: var(--accent-color);
			color: var(--dark-blue);
			min-width: 100px;
			height: 60px;
			border-radius: 30px;
			border: 3px solid var(--text-color);
			display: flex;
			align-items: center;
			justify-content: center;
			font-size: 1em;
			font-weight: 600;
			transition: all 0.2s;
			box-shadow: 0 0 10px rgba(137, 247, 254, 0.7);
			padding: 0 20px;
		}

		.player-container button:hover {
			transform: scale(1.05);
			background: var(--hug-color);
		}
		
		/* Sound Wave Visualization */
		.sound-wave {
			width: 150px;
			height: 50px;
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin: 40px 0;
		}
		.bar {
			width: 15px;
			height: 10%;
			background-color: var(--hug-color);
			border-radius: 5px;
			animation: sound 0s ease-in-out infinite alternate;
			opacity: 0.5;
		}
		.bar:nth-child(1) { animation-duration: 0.7s; }
		.bar:nth-child(2) { animation-duration: 0.9s; }
		.bar:nth-child(3) { animation-duration: 0.6s; }
		.bar:nth-child(4) { animation-duration: 0.8s; }
		.bar.paused { animation-play-state: paused; opacity: 0.3; height: 10%; }

		@keyframes sound {
			0% { height: 10%; }
			100% { height: 100%; }
		}
		
		/* --- GIFT BOX STYLES --- */

		/* Pulsing animation */
		@keyframes heartPulse {
			0% { transform: scale(1); box-shadow: 0 10px 20px var(--box-shadow-color); }
			50% { transform: scale(1.04); box-shadow: 0 15px 30px rgba(255, 182, 193, 0.5); }
			100% { transform: scale(1); box-shadow: 0 10px 20px var(--box-shadow-color); }
		}

		.gift {
			position: relative;
			display: flex;
			flex-direction: column;
			align-items: center;
			cursor: pointer;
			opacity: 1;
			transition: opacity 0.5s ease;
			animation: heartPulse 2s ease-in-out infinite alternate;
			
			/* This is needed for the 3D lid animation! */
			perspective: 1000px;
			transform-style: preserve-3d;
		}
		
		.gift-grid {
			display: flex;
			gap: 40px;
			position: relative;
			z-index: 12;
		}
		
		.gift.opened {
			opacity: 0.6;
			cursor: default;
		}

		.gift-title {
			width: 100%;
			text-align: center;
			font-family: 'Dancing Script', cursive;
			font-size: 3.5em;
			margin-bottom: 30px;
			color: var(--accent-color);
			position: relative;
			z-index: 12;
		}
		
		/* GIFT BOX BODY */
		.gift-box {
			width: 150px;
			height: 120px;
			/* Gradient for soft 3D look */
			background: linear-gradient(to bottom, var(--gift-box-color) 0%, var(--gift-box-color-dark) 100%);
			position: relative;
			border-radius: 12px;
			box-shadow: 0 8px 15px var(--box-shadow-color), inset 0 2px 4px var(--inset-shadow-color); /* Highlight + shadow */
			border: none;
		}

		/* Vertical Ribbon on BOX BODY */
		.gift-box::before {
			content: '';
			position: absolute;
			width: 30px;
			height: 100%;
			background-color: var(--gift-ribbon-color);
			box-shadow: 0 1px 3px rgba(0,0,0,0.1);
			left: 50%;
			transform: translateX(-50%);
			z-index: 1;
			border-radius: 2px; /* Soften ribbon edges */
		}
		.gift-box::after {
			content: none; /* Disable old pseudo-element */
		}


		/* LID STYLES */
		.lid {
			width: 158px; /* Slightly wider than box */
			height: 35px; /* Slightly taller */
			background: linear-gradient(to bottom, #ffe8f1 0%, var(--gift-lid-color) 100%); /* Lighter top */
			position: absolute;
			top: -18px;
			left: 50%;
			transform: translateX(-50%);
			border-radius: 12px;
			z-index: 10;
			box-shadow: 0 5px 12px var(--box-shadow-color), inset 0 3px 5px var(--inset-shadow-color);
			border: none;
			
			/* This is vital for the 3D animation */
			transform-style: preserve-3d;
			transform-origin: center bottom;
		}

		/* Vertical Ribbon on LID (sits under the bow) */
		.lid::before {
			content: '';
			position: absolute;
			width: 30px;
			height: 100%;
			background-color: var(--gift-ribbon-color);
			left: 50%;
			transform: translateX(-50%);
			z-index: 11;
			border-radius: 2px;
		}
		.lid::after {
			content: none; /* Disable old pseudo-element */
		}
		
		/* --- BOW ELEMENTS (styles for the new <span>s) --- */
		
		.bow-knot {
			position: absolute;
			width: 16px;
			height: 16px;
			background-color: var(--gift-ribbon-color);
			border-radius: 50%;
			left: 50%;
			top: -8px; /* On top of the lid */
			transform: translateX(-50%);
			z-index: 15; /* On top of everything */
			box-shadow: 0 2px 3px rgba(0,0,0,0.2);
		}

		.bow-loop-left,
		.bow-loop-right {
			content: '';
			position: absolute;
			width: 35px;
			height: 28px;
			background: var(--gift-ribbon-color);
			/* This creates the pinched loop shape */
			border-radius: 50% 50% 50% 50% / 100% 100% 0% 0%;
			top: -10px;
			box-shadow: 0 2px 5px rgba(0,0,0,0.2);
			z-index: 14; /* Below the knot */
		}

		.bow-loop-left {
			left: 50%;
			/* FIX: Symmetrical positioning. Moves left by its own width, then by half the knot's width */
			transform: translateX(-100%) translateX(-8px) rotate(-35deg);
		}

		.bow-loop-right {
			left: 50%;
			/* FIX: Symmetrical positioning. Moves right by half the knot's width */
			transform: translateX(8px) rotate(35deg);
		}
	
		.ribbon-end-left,
		.ribbon-end-right {
			content: '';
			position: absolute;
			width: 12px; /* Narrow ribbon ends */
			height: 25px;
			background: var(--gift-ribbon-color);
			z-index: 13; /* Below loops */
			top: 10px; /* Hanging down from lid */
			box-shadow: 0 3px 5px rgba(0,0,0,0.1);
			/* The "V" cut */
			clip-path: polygon(0 0, 100% 0, 100% 80%, 50% 100%, 0 80%);
		}
		
		.ribbon-end-left {
			left: 50%;
			/* FIX: Symmetrical positioning. */
			transform: translateX(-100%) translateX(-8px) rotate(-10deg);
		}
		
		.ribbon-end-right {
			left: 50%;
			/* FIX: Symmetrical positioning. */
			transform: translateX(8px) rotate(10deg);
		}

		/* --- 3D LID OPENING ANIMATION --- */
		.gift.open .lid {
			animation: openLid 1s ease-out forwards;
		}
		@keyframes openLid {
			0% {
				transform: translateX(-50%) translateY(0px) rotateX(0deg) translateZ(0px);
				opacity: 1;
			}
			50% {
				/* Lifts up, tilts back, and moves back in 3D space */
				transform: translateX(-50%) translateY(-60px) rotateX(-45deg) translateZ(-30px);
				opacity: 1;
			}
			100% {
				/* Flies up and away */
				transform: translateX(-50%) translateY(-150px) rotateX(-70deg) translateZ(-50px);
				opacity: 0;
			}
		}
		
		/* The Gift Label */
		.gift-label {
			margin-top: 20px; /* More space for the new lid */
			font-size: 1.2em;
			font-family: 'Poppins', sans-serif;
			font-weight: 600;
			color: var(--text-color); /* White text */
			text-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
			z-index: 12;
		}
		
		/* --- SPARKLE ANIMATION CSS (Background for Gift Screen) --- */
		#star-field {
			position: absolute;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			overflow: hidden;
			z-index: 9;
		}

		#star-field::before,
		#star-field::after {
			content: '';
			position: absolute;
			width: 100vw;
			height: 200vh;
			top: 0;
			left: 0;
			background-image: radial-gradient(var(--accent-color) 1px, transparent 1px);
			background-size: 50px 50px;
			animation: floatSparkles 30s linear infinite;
		}

		#star-field::after {
			background-size: 70px 70px;
			opacity: 0.6;
			animation-duration: 40s;
			animation-delay: -15s;
		}

		@keyframes floatSparkles {
			0% { transform: translateY(0); }
			100% { transform: translateY(-50%); }
		}
		
		#gift-screen {
			background: transparent;
		}
		
		/* --- HEART AND BURST ANIMATIONS (Birthday Theme) --- */
		.heart {
			position: absolute;
			bottom: -50px;
			color: var(--hug-color);
			animation: floatUp 8s linear infinite;
			pointer-events: none;
			text-shadow: 0 0 5px rgba(255, 182, 193, 0.5);
		}
		
		@keyframes floatUp {
			0% { transform: translateY(0); opacity: 1; }
			100% { transform: translateY(-110vh); opacity: 0; }
		}
		
		.heart-burst {
			position: fixed;
			font-size: 25px;
			color: var(--hug-color);
			pointer-events: none;
			z-index: 999;
			animation: burst 0.8s ease-out forwards;
		}
		
		@keyframes burst {
			0% { transform: translate(0, 0) scale(1) rotate(0deg); opacity: 1; }
			100% {
				transform: translate(var(--x), var(--y)) scale(0) rotate(var(--r));
				opacity: 0;
			}
		}

		/* --- FINALE SCREEN STYLES --- */
		#finale-screen { z-index: 30; background: var(--dark-blue); box-shadow: inset 0 0 100px var(--hug-color), 0 0 50px var(--hug-color); transition: box-shadow 3s ease-out; }
		#finale-screen h2 { font-size: 4em; color: var(--hug-color); }
		#finale-screen .message-text { font-size: 1.7em; font-weight: 600; color: var(--gift-ribbon-color); }
	</style>
</head>
<body>

	<div id="intro">
		<h1>üíô‚ú® Happy Birthday, My Leady üëë‚ú®üíô</h1>
		<div id="intro-prompt">Click to Begin this musical journey</div>
	</div>
	
	<div id="intro-msg-1" class="message-screen">
		<h2 id="intro-title-1">From My Sky to Yours... üåå</h2>
		<div class="message-text" id="intro-text-1"></div>
		<button class="next-btn" onclick="advanceStep()">Continue üíñ</button>
	</div>
	
	<div id="intro-msg-2" class="message-screen">
		<h2 id="intro-title-2">The Sweetest Melody... üé∂</h2>
		<div class="message-text" id="intro-text-2"></div>
		<button class="next-btn" onclick="advanceStep()">Next Chapter ‚ú®</button>
	</div>

	<div id="intro-msg-3" class="message-screen">
		<h2 id="intro-title-3">Celebrating Her Beautiful Charm... üíñ</h2>
		<div class="message-text" id="intro-text-3"></div>
		<button class="next-btn" onclick="advanceStep()">Listen to Our First Song üéß</button>
	</div>
	
	<div id="song-player-1" class="message-screen">
		<h2>Song For Devine Beauty üö∂‚Äç‚ôÄÔ∏è</h2>
		<div class="message-text">this song is dedicated your devine level beauty my Gabbu....</div>
		
		<div class="sound-wave" id="wave-1">
			<div class="bar paused"></div>
			<div class="bar paused"></div>
			<div class="bar paused"></div>
			<div class="bar paused"></div>
		</div>

		<div class="player-container">
			<button onclick="stopAllMusic()" title="Stop All Music">‚ùå Stop the Melody</button>
			<button id="play-pause-btn-1" onclick="togglePlayPause(1)">‚ù§Ô∏è Hear My Heart</button>
			<button class="next-song-btn" id="next-btn-1" onclick="advanceFromPlayer(1)" disabled>‚ú® Next Dream</button>
		</div>
	</div>
	
	<div id="intro-msg-4" class="message-screen">
		<h2 id="intro-title-4">Another one for you my Queen üëë</h2>
		<div class="message-text" id="intro-text-4"></div>
		<button class="next-btn" onclick="advanceStep()">Prepare the Music! üéµ</button>
	</div>

	<div id="song-player-2" class="message-screen">
		<h2>Song Dedication 2: For My Drama Queen ‚ú®</h2>
		<div class="message-text">This melody is a tribute to your Beautifull Eyes .</div>
		
		<div class="sound-wave" id="wave-2">
			<div class="bar paused"></div>
			<div class="bar paused"></div>
			<div class="bar paused"></div>
			<div class="bar paused"></div>
		</div>

		<div class="player-container">
			<button onclick="stopAllMusic()" title="Stop All Music">‚ùå Stop the Melody</button>
			<button id="play-pause-btn-2" onclick="togglePlayPause(2)">‚ù§Ô∏è Hear My Heart</button>
			<button class="next-song-btn" id="next-btn-2" onclick="advanceFromPlayer(2)" disabled>ü´Ç Open the Cuddle</button>
		</div>
	</div>

	<div id="intro-transition" class="message-screen">
		<h2>The Reason I Love You... ‚ù§Ô∏è</h2>
		<div class="message-text" id="intro-text-transition"></div>
		<button class="next-btn" onclick="advanceStep()">Open Your Gifts üéÅ</button>
	</div>
	
	<div id="gift-screen" class="message-screen">
		<div id="star-field"></div> <h1 class="gift-title">Choose Your Gifts...üéÅ</h1>
		
		<div class="gift-grid">
			
			<div class="gift" id="gift-1" onclick="openGift(1)">
				<div class="lid">
					<span class="bow-knot"></span>
					<span class="bow-loop-left"></span>
					<span class="bow-loop-right"></span>
					<span class="ribbon-end-left"></span>
					<span class="ribbon-end-right"></span>
				</div>
				<div class="gift-box"></div>
				<div class="gift-label">A Precious Memory üíå</div>
			</div>
			
			<div class="gift" id="gift-2" onclick="openGift(2)">
				<div class="lid">
					<span class="bow-knot"></span>
					<span class="bow-loop-left"></span>
					<span class="bow-loop-right"></span>
					<span class="ribbon-end-left"></span>
					<span class="ribbon-end-right"></span>
				</div>
				<div class="gift-box"></div>
				<div class="gift-label">A Forever Wish ‚ú®</div>
			</div>
			
			<div class="gift" id="gift-3" onclick="openGift(3)">
				<div class="lid">
					<span class="bow-knot"></span>
					<span class="bow-loop-left"></span>
					<span class="bow-loop-right"></span>
					<span class="ribbon-end-left"></span>
					<span class="ribbon-end-right"></span>
				</div>
				<div class="gift-box"></div>
				<div class="gift-label">An Unbreakable Promise üíû</div>
			</div>
		</div>
	</div>

	<div id="message-1" class="message-screen">
		<h2>A Precious Memory... üíå</h2>
		<div class="message-text" id="text-1"></div>
		<button class="next-btn" onclick="closeMessage(1)">Close & Back to Gifts</button>
	</div>
	<div id="message-2" class="message-screen">
		<h2>A Forever Wish... ‚ú®</h2>
		<div class="message-text" id="text-2"></div>
		<button class="next-btn" onclick="closeMessage(2)">Close & Back to Gifts</button>
	</div>
	<div id="message-3" class="message-screen">
		<h2>An Unbreakable Promise... üíû</h2>
		<div class="message-text" id="text-3"></div>
		<button class="next-btn" onclick="closeMessage(3)">Close & Back to Gifts</button>
	</div>
	
	<div id="finale-screen" class="message-screen screen">
		<h2>Happy Birthday, My Safe Place.. ü´Ç</h2>
		<div class="message-text" id="text-finale"></div>
	</div>

	<audio id="mainAudio"></audio>
	<div id="hearts-container"></div>

	<script type="module">
		// Firebase and Canvas environment imports (required)
		import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
		import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
		import { getFirestore } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";


		// --- CONFIGURATION (CHECK YOUR URLs HERE!) ---
		const config = {
			ambientVolume: 0.3,
			dedicatedVolume: 0.8,
			// NOTE: You must update these music URLs to your chosen tracks for them to work!
			ambientMusicUrl: "https://ik.imagekit.io/Hrishikesh2131/Untitled%20video%20-%20Made%20with%20Clipchamp.m4a?updatedAt=1761923211136",
			dedicatedSong1Url: "https://ik.imagekit.io/Hrishikesh2131/Taar%20Laagli%20_%20Rohit%20Raut%20_%20New%20Song%20_%20Pawan%20Singh%20_%20IPOPSTAR%20_%20IPOPSTAR%20FULL%20PERFORMANCES%20_ipopstar%20(1).m4a?updatedAt=1761894497631",
			dedicatedSong2Url: "https://ik.imagekit.io/Hrishikesh2131/Ajab%20Si%20Om%20Shanti%20Om%20320%20Kbps.mp3?updatedAt=1761853770085",
			minListenTimeSeconds: 5
		};
		
		// --- FINALIZED MESSAGES (All lines fixed and content updated) ---
		const messages = {
			"msg1": "Welcome, Pilyaaa, to a space crafted not with just code, but with the boundless admiration And Love I hold for you.This journey begins on a canvas bathed in Sky Blue üíô your favorite color i know, and its tribute to you Now you are asking ‡§ï‡§æ Tribute ‡§ï‡§∂‡§æ‡§∏‡§æ‡§†‡•Ä because . Just as you are a 'Blue Sky Thinker,' this endless blue reminds you that the universe is wide open for your grand aspirations and the big goals and your Dreams like MS,Buisness you will conquer this i know you.As you read, notice how the text seems to glow and shimmer, like distant stars‚ú®.That's you, my Little Star (Mann Ki baat -> ‡§ú‡§∏‡•á ‡§π‡•á  words Glow ‡§ï‡§∞‡§§‡§æ‡§Ø‡§§ same ‡§§‡§∂‡•Ä ‡§§‡•Å   Glow kartes and ‡§Ö‡§∂‡•Ä‡§ö glow kart ‡§∞‡§π‡§æ‡§∂‡§ø‡§≤ in your carrier and life ever and forever like a  glowing  star). Every element here is designed to be a reminder You shine like this, always.Take a deep breath. The gentle, soft melody beneath these words is the sound of my heart, reminding you that ‡§§‡•Å ‡§≤‡§Æ‡•ç‡§¨‡•á ‡§∞‡•á‡§∏ ‡§ï‡§æ ‡§ò‡•ã‡§°‡§æ sorry ‡§ò‡•ã‡§°‡•Ä ‡§π‡•à üêé,‡§§‡•ã ‡§Æ‡•á‡§∞‡•Ä ‡§ß‡§®‡§®‡•å ‡§Ö‡§≠‡•Ä ‡§ö‡§≤‡§®‡•á‡§ï‡§æ ‡§∏‡§Æ‡§Ø ‡§ó‡§Ø‡§æ ‡§ä‡§°‡§®‡•á‡§ï‡§æ ‡§∏‡§Æ‡§Ø ‡§Ü ‡§ö‡•Å‡§ï‡§æ ‡§π‡•à.... Like a Unicorn Every step will go towards your a Dreams.. SO be Ready.This journey is for you, my self-motivated, beautiful Lady.",
			"msg2": "You are truly the sweetest girl, my little baby.I know, I know‚Äîyou always complain that I save the best compliments( Hmmm ‡§§‡•Å ‡§Æ‡§æ‡§ù‡•Ä ‡§§‡§æ‡§∞‡§ø‡•û ‡§ï‡§ß‡•Ä ‡§ï‡§∞‡§§‡§ö ‡§®‡§æ‡§π‡•Ä‡§∏...üò° ‡§¨‡§æ‡§ï‡•Ä‡§ö‡•ç‡§Ø‡§æ ‡§™‡•ã‡§∞‡•Ä‡§®‡§ö‡•Ä ‡§¨‡§∞‡•Ä ‡§ï‡§∞‡§§‡•ã‡§∏.... ‡§§‡•Å‡§ú‡•ç‡§Ø‡§æ ‡§™‡•á‡§ï‡•ç‡§∑‡§æ ‡§Æ‡§æ‡§ú‡§æ ‡§ú‡§æ‡§® ‡§¨‡§∞‡§æ...), but I've been intentionally holding back for this special day. Why? Because you deserve a moment as beautiful as your heart.Your infectious, joyful laugh at your own perfectly lame jokes makes my entire day every time(‡§≤‡§à ‡§≠‡§æ‡§∞‡•Ä ‡§¶‡§ø‡§∏‡§§‡§∏...‡§§‡§∂‡•Ä ‡§π‡§∏‡§§‡•á‡§∏ ‡§§‡§µ‡§æ...üòò),. And your Beauty on Peak, especially when you wear a saree with gajara or kurti... well i am like...... ‡§∏‡§Ç‡§™‡§≤‡•ã‡§Ø ‡§∞‡•á ‡§Æ‡•Ä...... ‡§∏‡§Ç‡§™‡§≤‡•ã‡§Øüòéü•∞, that gives my heart butterflies ü¶ã! You look so incredibly cute and sweet beautifull in them(Mann ki Baat -> ‡§™‡§ø‡§µ‡§≥‡•ç‡§Ø‡§æ ‡§∞‡§Ç‡§ó‡§æ‡§ö‡•Ä kurtee ‡§ò‡§æ‡§≤‡§§‡•á‡§∏ ‡§®‡§æ..... ‡§¶‡§ø‡§µ‡§æ‡§≥‡•Ä‡§ö‡§æ ‡§ï‡§Ç‡§¶‡•Ä‡§≤ ‡§¶‡§ø‡§∏‡§§‡•á‡§∏.... ‡§∏‡•Å‡§Ç‡§¶‡§∞ ‡§Ü‡§£‡§ø bright),and i can watch you all day( Mann ki Baat -> Naruto ‡§∏‡•ã‡§°‡•Ç‡§® ‡§¶‡§ø‡§µ‡§∏‡§≠‡§∞ ‡§§‡•Å‡§≤‡§æ ‡§¨‡§ó‡§§ ‡§¨‡§∏‡•á‡§® ‡§è‡§µ‡§¢‡•Ä..... ‡§∏‡•Å‡§Ç‡§¶‡§∞ ‡§¶‡§ø‡§∏‡§§‡•á‡§∏).For me, you are pure, simple, the most beautiful thing in the world, and so very precious to me. I saved this moment because I'm dedicating a song only for you, right now. It's the perfect soundtrack for all those feelings I hold inside. Never change a single thing about yourself my Babyüé∂(Mann ki Baat -> ‡§∏‡§Ç‡§™‡§≤‡•ã‡§Ø ‡§∞‡•á ‡§Æ‡•Ä........ ‡§∏‡§Ç‡§™‡§≤‡•ã‡§Øüòéü•∞). (‡§π‡§æ‡§∏‡•Å ‡§®‡§ï‡•ã ‡§Ü‡§§‡§æ... ‡§ú‡§Æ‡§£‡§æ‡§∞ ‡§π‡§æ‡§Ø ‡§ï‡§æ ‡§§‡•Å‡•õ‡•ç‡§Ø‡§æ ‡§ú‡§æ‡§® ‡§≤‡§æ ‡§π‡•á ‡§∏‡§ó‡§≥‡§æ.. ‡§´‡§æ‡§≤‡•ç‡§§‡•Ç ‡§Æ‡§æ‡§£‡•Å‡§∏... AN RD an Emrru Tuza te pn ‡§´‡§æ‡§≤‡•ç‡§§‡•Ç) Hmmm zala kar next aata.... ",
			"msg3": "My Dearest Sundari,Before the music starts, I have to give you your official, most accurate Discription of your Beauty. You know I can write a million poems about you mhanshil ‡§ï‡§æ‡§Ø ‡§´‡•á‡§ñ‡§§‡•ã‡§Ø ‡§Ü‡§ú ‡§™‡§∞‡•ç‡§Ø‡§Ç‡§§ ‡§è‡§ï ‡§ï‡§µ‡§ø‡§§‡§æ ‡§®‡§æ‡§Ø ‡§ï‡•á‡§≤‡•Ä ‡§Ø‡§æ ‡§Æ‡§æ‡§®‡§∏‡§®‡•á ‡§Ü‡§£‡§ø ‡§≤‡§ø‡§π‡§ø‡§§‡•ã‡§Ø million poem.., but sometimes, the simple, honest truth is the most beautiful.I know the world loves thin, but I love my girl just the way she is.You aren‚Äôt chubby. You are **OG** (Original Goddess). Your figure is the definition of Sundari perfectly rounded,perfectly curvey ,perfectly soft, and perfectly made for my hugs(Man ki Baat -> ‡§≤‡§à ‡§ó‡•Å‡§¨‡•Ç‡§ó‡•Å‡§¨‡•Ç ‡§π‡§æ‡§Ø‡§∏ ‡§¨‡§ó...). The way you carry yourself is pure grace,But the best part? The best part is your own natural smell. It's not any perfume or anything you put on‚Äîit‚Äôs just you. That simple, unique scent of you is divine to me. It makes me feel instantly at ease and completely yours. You are pure, uncut, OG Khubsurt , from your peach figure to your divine natural scent(mann ki baat -> ‡§ú‡§µ‡§≥ ‡§Ø‡•á‡§§‡•ã ‡§®‡§æ ‡§ï‡§æ‡§Ø  smell yeto yaaar same like ‡§ï‡§∏‡•ç‡§§‡•Å‡§∞‡•Ä‡§ö‡§æ you are my  ‡§ï‡§∏‡•ç‡§§‡•Å‡§∞‡•Ä.... Very Erotic...ü´†ü´¶)",
			"msg4": "Hello ‡§Æ‡§æ‡§ï‡§°‡•á ü¶ßü¶ßüêí ‡§Ü‡§µ‡§°‡§§‡§Ø ‡§®‡§æ ‡§∏‡§ó‡§≥‡§æ ‡§Ü‡§µ‡§°‡§≤‡§ö ‡§™‡§æ‡§π‡§ø‡§ú‡•á..... Wait ‡§ï‡§æ‡§Ø ‡§§‡§∞‡•Ä ‡§∞‡§æ‡§π‡•Ä‡§≤‡§æ‡§Ø ‡§ï‡§æ‡§Ø ‡§∞‡§æ‡§π‡•Ä‡§≤‡§æ‡§Ø.....sangu ka..sangu ka... bol ki sangu ka... kay rahilay te!!!! mi sagla boloy aadhi pn bolat aaloy ‡§§‡•Å‡•õ‡§æ ‡§®‡§æ‡§ï ‡§ú‡§∏‡§æ ‡§™‡•ã‡§™‡§ü‡§æ‡§ö‡•Ä ‡§ö‡•ã‡§ö...‡§§‡•Å‡§ù‡•á ‡§ì‡§†.. ‡§Ü‡§£‡§ø ‡§∏‡§ó‡§≥‡§ö ‡§™‡§®... ‡§™‡§®... ‡§è‡§ï ‡§∞‡§æ‡§π‡•Ä‡§≤‡§æ‡§Ø.. Your Beautifull Eyes i never talk lot about Eyes today is the day..Your eyes are so beautifully shaped they truly light up your whole face..when you apply kajal your Eyes look like deep, sparkling pools... Your smile become so special because the way your eyes form those beautiful crescent shapes instantly tells me how happy you are. That genuine crinkle is one of your most attractive features and it just melts my heart...  My Queen of Expressions,I could live a whole lifetime without hearing you speak a single word, and I'd still know exactly what's going on in that brilliant head of yours. Why? Because you talk the loudest with your eyes When you‚Äôre happy, they sparkle like a thousand fireflies. When you‚Äôre upset, I see the whole drama of the universe unfolding in those two little Eyes. Seriously, you are my personal Expression Queen and Drama Queen(Mann ki Baat -> Entertainment Entertainment and Entertainment...), and I wouldn‚Äôt have it any other way.Those eyes tell me everything‚Äîyour secrets, excitement, your tired day, your happyness your sadness and most importantly, they always hold that unwavering love for me(mann ki baat -> ‡§§‡•á ‡§ï‡§ß‡•Ä‡§ö ‡§ñ‡•ã‡§ü‡§æ ‡§®‡§æ‡§Ø ‡§¨‡•ã‡§≤‡§§ ‡§§‡•Å ‡§®‡§æ‡§π‡•Ä ‡§¨‡•ã‡§≤‡§ø‡§∏  ignore kelas ‡§§‡§∞‡•Ä ‡§§‡•á ‡§∏‡§æ‡§Ç‡§ó‡§§‡§æ‡§§ ‡§∏‡§ó‡§≥‡§æ). It‚Äôs my favorite language, the one you speak without making a sound. Aani aata SOng for my babys Beautiful Eyes",
			"transition": "Every time you open one of these, remember that just as you feel safe in my **hug**, I feel whole because of your kind, chubby presence. you know i am jobless not have money even my monthly recharge tu kartes so i dont have anyting to give you precious on your specail day but one day i will. ya but These upcomming gifts are not just words, but a piece of my heart traveling across the distance to you. **It's time for the cuddle...**",
			"gift1": "My favorite memory? It's memories lots of memories... every night whenever we alone or got chance  I got to **cuddle** you‚Äîyou sleeping like my small, cute **baby** girl(Mann ki Baat -> like my small baby girl   ). That peace, that safety... that feeling is the Memory I carry through my life until my Death. ‡§§‡•Å‡§ú‡§æ ‡§§‡•ã ‡§π‡§ü‡•ç‡§ü‡•Ä‡§™‡§£‡§æ ‡§≤‡§π‡§æ‡§® ‡§¨‡§æ‡§≥‡§æ ‡§∏‡§æ‡§∞‡§ñ‡§æ cute Ummm ‡§ï‡§∞‡§®‡§æ ‡§Ü‡§£‡§ø ‡§ú‡•á ‡§Æ‡§≤‡§æ ‡§õ‡•ã‡§ü‡•Å‡§∂‡§æ ‡§¨‡§æ‡§≥‡§æ ‡§∏‡§æ‡§∞‡§ñ‡§æ ‡§¨‡§ø‡§≤‡§ó‡•Å‡§£ ‡§ù‡•ã‡§™‡§§‡•á‡§∏ ‡§™‡§∞‡§§ ‡§ñ‡•ã‡§°‡•ç‡§Ø‡§æ ‡§ï‡§æ‡§°‡§§‡•á‡§∏ ‡§Æ‡§∏‡•ç‡§§‡•Ä ‡§ï‡§∞‡§§‡•á‡§∏.... ‡§Æ‡§æ‡§ù‡§æ ‡§ó‡§æ‡§≤ ‡§≤‡§æ‡§≤ ‡§ï‡§∞‡§§‡§ø‡§∏ ‡§ï‡•Å‡§§‡•ç‡§∞‡•á ‡§Æ‡§æ‡§∞‡•Å‡§® ‡§Æ‡§æ‡§∞‡•Å‡§® ‡§Ü‡§£‡•Ä ‡§Æ‡§ó ‡§Æ‡•Ä ‡§∂‡§æ‡§Ç‡§§ ‡§¨‡§∏‡§≤‡•ã ‡§ï‡•Ä ‡§π‡§≥‡•Ç‡§ö ‡§Ø‡§æ‡§Ø‡§ö ‡§≤‡§π‡§æ‡§® ‡§¨‡§æ‡§≥‡§æ ‡§∏‡§æ‡§∞‡§ñ‡§æ ‡§Ü‡§£‡•Ä ‡§¨‡•ã‡§≤‡§æ‡§Ø‡§ö ‡§ö‡§æ‡§Ç‡§ó‡§≤‡•Ä ‡§π‡§æ‡§Ø ‡§®‡§æ ‡§Æ‡•Ä ‡§¶‡§æ‡§§ ‡§ï‡§æ‡§°‡§§ tula vatat nay na kay mi marla yala kashi aahes na tu bichara mi....ü´†ü§£‡§™‡§∞‡§§ ‡§§‡•Å‡§≤‡§æ ‡§§‡§æ‡§∏‡§®‡§§‡§æ‡§∏ ‡§Æ‡§ø‡§†‡§ø‡§§ ‡§ò‡•á‡§ä‡§® ‡§ó‡§™‡•ç‡§™‡§æ ‡§Æ‡§æ‡§∞‡§®üí´ tuza te rusna jeva tu ‡§∞‡•Å‡§∏‡•Å‡§® bastis ‡§®‡§æ ‡§è‡§ï‡§¶‡§Æ ‡§õ‡•ã‡§ü‡•Å‡§∂‡§æ ‡§π‡§§‡•ç‡§§‡•Ä ‡§∏‡§æ‡§∞‡§ñ‡§æ ‡§µ‡§æ‡§ü‡§Ç‡§§ ‡§Æ‡§≤‡§æ ‡§Æ‡§æ‡§ù‡•Ä  ‡§ó‡§¨‡•ç‡§¨‡•Å  mag kay baba tula jawal gyaycha tuza laad karaycha ticha raag kadaycha mg ‡§π‡§æ‡§∏‡•Å ‡§Ø‡•á‡§§‡§æ ‡§ñ‡•Å‡§¶‡§ï‡§®.. lai aavdta na tula he sagla.. i am writing all this right now and your presence and your touch your smell i am feeling write away same as you are.... Thoes memories make distance feel temporary.‡§§‡•Å‡§≤‡§æ ‡§Æ‡•Ä ‡§¨‡•ã‡§≤‡§§‡•ã ‡§®‡§æ pilyaa pillu ‡§§‡•ç‡§Ø‡§æ‡§ö‡§æ ‡§ï‡§æ‡§∞‡§® ‡§Æ‡•Ä starting la bolo hoto ani i hope tula te as usual lakshat nasnar nasnarch lakshat ganjni hays tu gajni kuthchi(Man KI baat -> kay lakshat asta g tuzya... aa) preeti l love you -> short form pilu asa hota te...üòÇüòÇ but aata vichar kela tr khup deep meaning aahe like my child you are like you call me mumma and i am starting to feel like this to taking care of you ‡§§‡•Å‡§≤‡§æ ‡§∞‡§æ‡§ó‡§µ‡§æ‡§Ø‡§ö ‡§§‡•Å‡§≤‡§æ ‡§∏‡§Æ‡§ú‡§µ‡§æ‡§Ø‡§ö ‡§Ü‡§£‡§ø ‡§Ü‡§™‡§≤‡•Ä ‡§§‡§∞ ‡§¨‡•ã‡§Ç‡§¨ ‡§§‡§∞ ‡§Ü‡§π‡•á‡§ö ‡§∏‡§Æ‡§ú‡•Ç‡§® ‡§ò‡•ç‡§Ø‡§æ‡§Ø‡§ö‡•Ä ‡§π‡•ã ‡§Ü‡§π‡•á ‡§¨‡•ã‡§Ç‡§¨ ‡§Ü‡§£‡§ø ‡§Æ‡§≤‡§æ ‡§™‡§∞‡§§ ‡§™‡§∞‡§§ ‡§∏‡§æ‡§Ç‡§ó‡§æ‡§µ ‡§≤‡§æ‡§ó‡§§ ‡§ï‡•Ä ‡§Ö‡§∏‡§æ ‡§ï‡§∞ ‡§Ö‡§∏ ‡§ï‡§∞ ‡§§‡§µ‡§æ ‡§ú‡§æ‡§ä‡§® ‡§§‡•Å‡§≤‡§æ ‡§∏‡§Æ‡§ú‡§§‡§Ø(mun ki baat -> mumma kad jaychay ja mg.. ti ny dusri mumma....) So yes those are my precious memories.... ho aahet ki romantic memories pn aahet tula tech aathavnar paus, pahila kiss hay na hasu nakko.... ajibaat hasaycha nay bar ka.. bass ata focus kar.. ha kay bolt hoto jya ki over call aapn bolto khup vela bolloy but he i guess khup kami bolo so mhanun he sweet memories ajun khup aahet aaata tya jawal basun recreate karu lavakarch tuzya mithi madhe....ü´Ç ",
			"gift2": "My **Wish** is that you never feel the need to change for anyone, especially not your beautiful **chubbiness** and ofcourse your Swabhav... You are perfect, adorable, and delicious just the way you are(mann Ki baat -> yes you are... you are delicious). May all your opportunities under that **sky** come true! including your Ms goal, foregin trip,your own buisness and ofcourse child with me....üòÇüòÇ this is one of our wish ok and our marrige also and our DReams to our to do list to... so on serious note i wish that kaka always bless you and he also  watching you and with you always.., all people restpect you including me and they treat you like pincess like i treat you(yes i know, i know sometimes i treat you not every time but you are my crown prnicess and your word is i have to obey..) and every problems and tenshions,every thing that you suffers is goes away and this birthday gives you lot of joy and sucess to you Happy 26th birthday baby.. this is my wish for you.. yes ek visarlo tuzya hatchi misal vadapaw ani pavbhaji ani te sagla je tu mala sangitlas including chapati cha pizza i want to taste all this things yes i want your hatchi batata bhaji also yes i also want to tasate you agin and again and again and again and infinite.... i know i did many times but yes this is my lifetime wish your taste is devine unforgottable... this is my naughty wish...üòÇüòÇ serious wish varch sampli Byeee ata... ‚ú®",
			"gift3": "My **Promise** is simple: I will always be your **safe space**. Your **hug** will always be waiting. I promise to support your cooking,your dreams your good decision and taking responsibilities of your bad decisions to always why because i am your mumma(mumma kade jaychay ... mg jaa.. tya nay hyaa..üòÇüòÇ) i teach you every thing again and again until tuzya dokyat basat nay...(mann ki baat-> teach kam hay maza) when you need and requried i stand behind you with you always with your adventures (and eat all the food!) and to always treat you like the precious little girl you are to me. I love you, baby. üíû",
			"finale": "This is my **hug(Your safest place)**. I‚Äôm holding you tight now. Close your eyes, feel the warmth, and know that you are **safe** here. Happy Birthday to the most beautiful, kind, and chubby girl in my world. I love you always, my **Little Star**! üéÇüíñ"
		};

		// --- END FINALIZED MESSAGES ---
		
		const songData = {
			1: { url: config.dedicatedSong1Url, waveId: 'wave-1', buttonId: 'play-pause-btn-1', nextBtnId: 'next-btn-1' },
			2: { url: config.dedicatedSong2Url, waveId: 'wave-2', buttonId: 'play-pause-btn-2', nextBtnId: 'next-btn-2' }
		};

		const intro = document.getElementById('intro');
		const mainAudio = document.getElementById('mainAudio');
		const heartsContainer = document.getElementById('hearts-container');
		
		// Centralized screen map for flow control
		const allScreens = {
			1: { el: document.getElementById('intro-msg-1'), textId: 'intro-text-1', msg: messages.msg1, audio: 'ambient' },
			2: { el: document.getElementById('intro-msg-2'), textId: 'intro-text-2', msg: messages.msg2, audio: 'ambient' },
			3: { el: document.getElementById('intro-msg-3'), textId: 'intro-text-3', msg: messages.msg3, audio: 'ambient' },
			4: { el: document.getElementById('song-player-1'), songNum: 1, audio: 'player' },
			5: { el: document.getElementById('intro-msg-4'), textId: 'intro-text-4', msg: messages.msg4, audio: 'ambient' },
			6: { el: document.getElementById('song-player-2'), songNum: 2, audio: 'player' },
			7: { el: document.getElementById('intro-transition'), textId: 'intro-text-transition', msg: messages.transition, audio: 'ambient' },
			8: { el: document.getElementById('gift-screen'), audio: 'ambient' }
		}

		let currentStep = 0;
		let giftsOpened = 0;
		const totalGifts = 3; 
		
		// Global state for ambient music tracking
		let ambientTime = 0;
		let isAmbientSource = true;
		let activeSongNum = 0;
		
		// --- Firebase/Canvas Boilerplate ---
		let db, auth;
		let userId = 'anonymous';
		async function initializeFirebase() {
			try {
				const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
				const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
				const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
				
				if (firebaseConfig) {
					const app = initializeApp(firebaseConfig);
					auth = getAuth(app);
					db = getFirestore(app);
					
					if (initialAuthToken) {
						await signInWithCustomToken(auth, initialAuthToken).then(userCredential => { userId = userCredential.user.uid; })
						.catch(error => { signInAnonymously(auth).then(userCredential => { userId = userCredential.user.uid; }); });
					} else {
						await signInAnonymously(auth).then(userCredential => { userId = userCredential.user.uid; });
					}
				}
			} catch (e) { console.error("Firebase initialization failed:", e); }
		}
		
		// --- Audio Control Core ---

		function updatePlayerUI(songNum, playing) {
			const { waveId, buttonId } = songData[songNum];
			const btn = document.getElementById(buttonId);
			const wave = document.getElementById(waveId);
			if (btn && wave) {
				btn.innerHTML = playing ? '‚è∏Ô∏è Hold the Moment' : '‚ù§Ô∏è Hear My Heart';
				wave.querySelectorAll('.bar').forEach(bar => {
					playing ? bar.classList.remove('paused') : bar.classList.add('paused');
				});
			}
		}
		
		function playMusic(url, volume, loop = false, fade = true) {
			if (mainAudio.src.split('?')[0] !== url.split('?')[0]) {
				mainAudio.src = url;
				mainAudio.load();
				isAmbientSource = (url === config.ambientMusicUrl);
			}
			mainAudio.loop = loop;
			mainAudio.play().catch(e => console.log("Autoplay blocked/failed:", e));

			if (!fade) {
				mainAudio.volume = volume;
				return;
			}
			
			let v = mainAudio.volume;
			const targetVolume = volume;
			const fadeInterval = setInterval(() => {
				if (v < targetVolume) {
					v += 0.02;
					mainAudio.volume = Math.min(v, targetVolume);
				} else {
					mainAudio.volume = targetVolume;
					clearInterval(fadeInterval);
				}
			}, 100);
		}

		function pauseCurrentTrack() {
			mainAudio.pause();
			if (!isAmbientSource && activeSongNum > 0) {
				updatePlayerUI(activeSongNum, false);
			}
		}

		function stopAllMusic() {
			mainAudio.pause();
			mainAudio.currentTime = 0;
			if (!isAmbientSource && activeSongNum > 0) {
				updatePlayerUI(activeSongNum, false);
			}
			activeSongNum = 0;
		}

		function resumeAmbient() {
			if (mainAudio.src.split('?')[0] !== config.ambientMusicUrl.split('?')[0]) {
				mainAudio.src = config.ambientMusicUrl;
				mainAudio.load();
				isAmbientSource = true;
			}
			mainAudio.currentTime = ambientTime;
			mainAudio.loop = true;
			playMusic(config.ambientMusicUrl, config.ambientVolume, true, false);
			ambientTime = 0;
		}

		function pauseAndSaveAmbient() {
			if (isAmbientSource && !mainAudio.paused) {
				ambientTime = mainAudio.currentTime;
				mainAudio.pause();
				return true;
			}
			return false;
		}

		function togglePlayPause(songNum) {
			activeSongNum = songNum;
			const songUrl = songData[songNum].url;

			if (!isAmbientSource && !mainAudio.paused) {
				pauseCurrentTrack();
			} else {
				pauseAndSaveAmbient();
				playMusic(songUrl, config.dedicatedVolume, true, true);
				updatePlayerUI(songNum, true);
				
				const nextBtn = document.getElementById(songData[songNum].nextBtnId);
				setTimeout(() => {
					nextBtn.disabled = false;
					nextBtn.style.background = 'var(--hug-color)';
				}, config.minListenTimeSeconds * 1000);
			}
		}

		// --- Flow Control Functions ---

		function hideCurrentScreen() {
			document.querySelectorAll('.message-screen').forEach(m => {
				if (m.style.display === 'flex') {
					m.style.display = 'none';
					m.querySelector('.message-text')?.classList.remove('breathing-text');
				}
			});
		}
		
		function advanceStep() {
			hideCurrentScreen();
			currentStep++;
			const nextScreen = allScreens[currentStep];
			if (!nextScreen) return;
			
			nextScreen.el.style.display = 'flex';
			
			if (nextScreen.audio === 'ambient') {
				if (mainAudio.paused || !isAmbientSource) {
					const doFade = currentStep === 1;
					playMusic(config.ambientMusicUrl, config.ambientVolume, true, doFade);
				}
			} else if (nextScreen.audio === 'player') {
				activeSongNum = nextScreen.songNum;
				mainAudio.pause();
				updatePlayerUI(activeSongNum, false);
				mainAudio.src = songData[nextScreen.songNum].url;
				mainAudio.load();
				isAmbientSource = false;
			}

			if (nextScreen.textId) {
				typeWriterEffect(nextScreen.textId, nextScreen.msg);
			}
		}

		function advanceFromPlayer(songNum) {
			mainAudio.pause();
			mainAudio.currentTime = 0;
			activeSongNum = 0;
			hideCurrentScreen();
			currentStep++;
			
			const nextScreen = allScreens[currentStep];
			if (!nextScreen) return;
			
			nextScreen.el.style.display = 'flex';
			resumeAmbient();
			if (nextScreen.textId) {
				typeWriterEffect(nextScreen.textId, nextScreen.msg);
			}
		}

		// --- Start Sequence ---

		function startJourney() {
			if (intro.classList.contains('started')) return;
			intro.classList.add('started');

			intro.style.animation = "fadeOut 2s ease forwards";
			setInterval(createFloatingHeart, 700);
			
			setTimeout(() => {
				currentStep = 0;
				advanceStep();
			}, 1000);
		}

		intro.addEventListener('click', startJourney, { once: true });
		

		window.onload = initializeFirebase;
		
		// --- Gift and Finale Logic ---
		function openGift(giftNum) {
			const giftElement = document.getElementById(`gift-${giftNum}`);
			if (giftElement.classList.contains('opened')) return;

			giftElement.classList.add('opened', 'open');
			giftsOpened++;
			
			// Trigger the dramatic heart burst confetti
			createHeartBurst(giftElement);

			const messageId = `message-${giftNum}`;
			const textId = `text-${giftNum}`;
			
			setTimeout(() => {
				document.getElementById(messageId).style.display = "flex";
				typeWriterEffect(textId, messages[`gift${giftNum}`]);
			}, 800);
		}

		function closeMessage(giftNum) {
			const messageElement = document.getElementById(`message-${giftNum}`);
			messageElement.style.display = 'none';
			messageElement.querySelector('.message-text').classList.remove('breathing-text');
			
			if (giftsOpened === totalGifts) {
				showFinale();
			}
		}
		
		function showFinale() {
			document.getElementById('gift-screen').style.animation = "fadeOut 1s ease forwards";
			
			const finaleScreen = document.getElementById('finale-screen');
			finaleScreen.style.display = "flex";
			finaleScreen.style.opacity = "1";

			if (mainAudio.paused && isAmbientSource) {
				playMusic(config.ambientMusicUrl, config.ambientVolume, true, false);
			}

			typeWriterEffect('text-finale', messages.finale);
			createHeartBurst(finaleScreen, 50);
		}

		// --- Effects (Typewriter, Hearts) ---
		function typeWriterEffect(elementId, text) {
			const textElement = document.getElementById(elementId);
			textElement.innerHTML = "";
			textElement.classList.remove('breathing-text');
			let i = 0;
			const speed = 50;
			
			const interval = setInterval(() => {
				if (i < text.length) {
					let char = text.charAt(i);
					if (text.substring(i, i + 2) === '**') {
						let end = text.indexOf('**', i + 2);
						if (end !== -1) {
							textElement.innerHTML += '<strong>' + text.substring(i + 2, end) + '</strong>';
							i = end + 2;
						} else {
							textElement.innerHTML += char;
							i++;
						}
					} else if (char === '\n') {
						textElement.innerHTML += '<br>';
						i++;
					} else {
						textElement.innerHTML += char;
						i++;
					}
				} else {
					clearInterval(interval);
					textElement.classList.add('breathing-text');
				}
			}, speed);
		}

		function createFloatingHeart() {
			const heart = document.createElement('div');
			heart.classList.add('heart');
			heart.innerHTML = ['üíñ','‚ù§Ô∏è','‚ú®','üíò','üíô'][Math.floor(Math.random() * 5)];
			heart.style.left = Math.random() * 100 + 'vw';
			heart.style.fontSize = 20 + Math.random() * 35 + 'px';
			heart.style.animationDuration = 6 + Math.random() * 4 + 's';
			heartsContainer.appendChild(heart);
			setTimeout(() => heart.remove(), 10000);
		}
		
		function createHeartBurst(element, count = 30) {
			const rect = element.getBoundingClientRect();
			const startX = rect.left + rect.width / 2;
			// Use the center of the element for burst, adjusting vertically for the gift box lid
			const startY = rect.top + rect.height / 2 + (element.id.includes('gift') ? 30 : 0);
			
			// This palette perfectly matches the image burst
			const palette = ['üíñ', '‚ú®', 'üíû', '‚ù§Ô∏è', 'ü´Ç', 'üíô', 'üëë'];

			for (let i = 0; i < count; i++) {
				const burstEl = document.createElement('div');
				burstEl.classList.add('heart-burst');
				burstEl.innerHTML = palette[i % palette.length];
				burstEl.style.left = startX + 'px';
				burstEl.style.top = startY + 'px';

				// Set random destinations
				const randX = (Math.random() - 0.5) * 400; // -200 to +200
				const randY = (Math.random() - 0.5) * 400; // -200 to +200
				const randR = (Math.random() - 0.5) * 720; // rotation

				burstEl.style.setProperty('--x', randX + 'px');
				burstEl.style.setProperty('--y', randY + 'px');
		        burstEl.style.setProperty('--r', randR + 'deg');

				document.body.appendChild(burstEl);
				setTimeout(() => burstEl.remove(), 800);
			}
		}
        
        // --- FIX: Expose functions to the global scope for inline onclick handlers ---
        window.advanceStep = advanceStep;
        window.stopAllMusic = stopAllMusic;
        window.togglePlayPause = togglePlayPause;
        window.advanceFromPlayer = advanceFromPlayer;
        window.openGift = openGift;
        window.closeMessage = closeMessage;

	</script>
</body>
</html>

